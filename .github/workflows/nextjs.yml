name: Deploy Next.js Frontend to EC2

on:
  push:
    branches:
      - main  # change if you deploy from another branch

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Clean install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Fresh Next.js build (ensure clean .next)
      - name: Build Next.js
        run: |
          rm -rf .next
          npm run build

      # 5Ô∏è‚É£ Verify .next exists after build
      - name: Verify .next folder
        run: |
          if [ ! -d ".next" ]; then
            echo "‚ùå ERROR: .next directory not found ‚Äî build likely failed."
            exit 1
          fi
          echo "‚úÖ .next build directory exists."
          ls -la .next

      # 6Ô∏è‚É£ Compress all required files into one archive (including hidden .next)
      - name: Compress build folder
        run: |
          echo "üì¶ Creating deployment archive..."
          tar -czf build.tar.gz \
            .next \
            public \
            src \
            LICENSE \
            README.md \
            jsconfig.json \
            package.json \
            package-lock.json \
            next.config.js
          echo "‚úÖ Archive contents:"
          tar -tf build.tar.gz | head -n 20
          
      - name: Verify archive contents
        run: |
          echo "üîç Checking if .next exists in archive..."
          tar -tf build.tar.gz | grep '^\.next/' || (echo "‚ùå .next not found in build.tar.gz!" && exit 1)


      # 7Ô∏è‚É£ Copy build to EC2
      - name: Copy build to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build.tar.gz"
          target: ${{ secrets.EC2_PATH }}
          overwrite: true

      # 8Ô∏è‚É£ SSH into EC2 and deploy
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "üìÇ Switching to project directory..."
            cd ${{ secrets.EC2_PATH }}
      
            echo "üì¶ Extracting build..."
            tar --overwrite --no-same-owner -xzf build.tar.gz
            rm build.tar.gz
      
            echo "üß© Verifying .next exists after extraction..."
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: .next directory missing after extraction!"
              ls -la
              exit 1
            fi
      
            echo "üöÄ Restarting PM2 app..."
            pm2 restart tsgmart_frontend || pm2 start npm --name "tsgmart_frontend" -- start -- --port=3001 
            pm2 save
      
            echo "‚úÖ Deployment complete!"

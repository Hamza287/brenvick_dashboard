name: Deploy Next.js Frontend to EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4Ô∏è‚É£ Build Next.js (reads updated .env.production)
      - name: Build Next.js
        run: |
          echo "üß™ Using environment variables:"
          cat .env.production || echo "‚ö†Ô∏è .env.production not found!"

          rm -rf .next
          npm run build

      # 5Ô∏è‚É£ Verify .next
      - name: Verify .next folder
        run: |
          if [ ! -d ".next" ]; then
            echo "‚ùå ERROR: .next directory not found ‚Äî build failed."
            exit 1
          fi
          echo "‚úÖ .next exists."
          ls -la .next

      # 6Ô∏è‚É£ Create archive INCLUDING .env files
      - name: Compress build folder
        run: |
          echo "üì¶ Creating deployment archive..."

          # include ALL .env* files (.env, .env.production, .env.local, etc.)
          FILES_TO_ARCHIVE=".next public src .env* jsconfig.json package.json package-lock.json next.config.mjs tsconfig.json postcss.config.mjs next-env.d.ts"

          TAR_CMD="tar -czf build.tar.gz"

          for FILE in $FILES_TO_ARCHIVE; do
            if ls $FILE 1> /dev/null 2>&1; then
              TAR_CMD="$TAR_CMD $FILE"
            else
              echo "‚ö†Ô∏è '$FILE' not found, skipping..."
            fi
          done

          echo "Running: $TAR_CMD"
          $TAR_CMD

          echo "üìÇ Archive preview:"
          tar -tf build.tar.gz | head -n 20

      - name: Verify archive contains env files
        run: |
          echo "üîç Checking .env files in archive..."
          tar -tf build.tar.gz | grep '.env' || echo "‚ö†Ô∏è No env files found!"

      # 7Ô∏è‚É£ Copy to EC2
      - name: Copy build to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build.tar.gz"
          target: ${{ secrets.EC2_PATH }}
          overwrite: true

      # 8Ô∏è‚É£ SSH and deploy on EC2
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd ${{ secrets.EC2_PATH }}

            echo "üì¶ Extracting build..."
            tar --overwrite --no-same-owner -xzf build.tar.gz
            rm build.tar.gz

            echo "üß© Checking .next..."
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: .next is missing after extraction!"
              exit 1
            fi

            echo "üîç Checking for .env.production..."
            if [ ! -f ".env.production" ]; then
              echo "‚ùå ERROR: .env.production missing after extraction!"
              ls -la
              exit 1
            fi

            echo "üöÄ Restarting PM2..."
            pm2 restart brenvick_dashboard || pm2 start npm --name "brenvick_dashboard" -- start -- --port=3002 
            pm2 save

            echo "‚úÖ Deployment complete!"
